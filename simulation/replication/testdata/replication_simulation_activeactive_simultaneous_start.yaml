# This file is a replication simulation scenario spec.
# It is parsed into ReplicationSimulationConfig struct.
# Replication simulation for this file can be run via ./simulation/replication/run.sh signalwithstart_activeactive_conflict
# Dynamic config overrides can be set via config/dynamicconfig/replication_simulation_signalwithstart_activeactive_conflict.yml

clusters:
  cluster0:
    grpcEndpoint: "cadence-cluster0:7833"
  cluster1:
    grpcEndpoint: "cadence-cluster1:7833"

# primaryCluster is where domain data is written to and replicates to others. e.g. domain registration
primaryCluster: "cluster0"

domains:
  test-domain-aa-conflict:
    activeClustersByRegion:
      region0: cluster0
      region1: cluster1

operations:
  # SignalWithStart workflow with same workflowID in cluster0
  - op: signal_with_start_workflow
    at: 0s
    workflowID: conflict-wf
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa-conflict
    signalName: signal-from-cluster0
    signalInput: "cluster0-signal-data"
    workflowExecutionStartToCloseTimeout: 65s
    workflowDuration: 35s
    runIDKey: cluster0-run

  # SignalWithStart workflow with SAME workflowID in cluster1 - testing conflict resolution
  - op: signal_with_start_workflow
    at: 1s
    workflowID: conflict-wf
    workflowType: timer-activity-loop-workflow
    cluster: cluster1
    domain: test-domain-aa-conflict
    signalName: signal-from-cluster1
    signalInput: "cluster1-signal-data"
    workflowExecutionStartToCloseTimeout: 65s
    workflowDuration: 35s
    runIDKey: cluster1-run

  - op: validate
    at: 10s
    workflowID: conflict-wf
    runIDKey: cluster0-run
    cluster: cluster0
    domain: test-domain-aa-conflict
    want:
      status: terminated
      startedByWorkersInCluster: cluster0
      completedByWorkersInCluster: cluster0

  - op: validate
    at: 10s
    workflowID: conflict-wf
    runIDKey: cluster1-run
    cluster: cluster0
    domain: test-domain-aa-conflict
    want:
      status: running
      startedByWorkersInCluster: cluster1

  # Query the cluster0 run to check if signal was received (should have cluster0 signal)
  - op: query_workflow
    at: 15s
    workflowID: conflict-wf
    cluster: cluster0
    domain: test-domain-aa-conflict
    query: "get_signals_received"
    runIDKey: cluster0-run
    want:
      queryResult: ["signal-from-cluster0"]

  # Query the cluster1 run to check if signal was received (should have cluster1 signal)
  - op: query_workflow
    at: 15s
    workflowID: conflict-wf
    cluster: cluster1
    domain: test-domain-aa-conflict
    query: "get_signals_received"
    runIDKey: cluster1-run
    want:
      queryResult: ["signal-from-cluster1"]
  
  - op: validate
    at: 70s
    workflowID: conflict-wf
    runIDKey: cluster1-run
    cluster: cluster0
    domain: test-domain-aa-conflict
    want:
      status: completed
      startedByWorkersInCluster: cluster1
      completedByWorkersInCluster: cluster1
